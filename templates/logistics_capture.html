{% extends "layout.html" %}

{% block title %}Captura de Materiales | AutoIntelli{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/dropdowns.js') }}"></script>
<style>
    .capture-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .items-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 1rem;
    }

    .items-table th {
        background: rgba(255, 255, 255, 0.05);
        padding: 1rem;
        text-align: left;
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 600;
    }

    .items-table td {
        background: rgba(255, 255, 255, 0.01);
        border-bottom: 1px solid var(--glass-border);
        padding: 0.5rem;
        vertical-align: middle;
        position: relative;
    }

    .items-table td:focus-within {
        z-index: 100;
    }

    .table-input {
        width: 100%;
        background: transparent;
        border: none;
        color: white;
        padding: 0.8rem 0.5rem;
        outline: none;
        font-family: inherit;
        font-size: 0.9rem;
    }

    .table-input:focus {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
    }

    select.table-input {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        cursor: pointer;
        color: white;
        background-color: transparent;
    }

    select.table-input option {
        background-color: #1a1a20;
        color: white;
    }

    .action-bar {
        margin-top: 1rem;
        display: flex;
        gap: 1rem;
    }
</style>
{% endblock %}

{% block sidebar_nav %}
<li class="menu-item">
    <a href="{{ url_for('logistics.home') }}"
        class="menu-link {% if request.endpoint == 'logistics.home' %}active{% endif %}">
        <i class="ph ph-truck"></i> <span>Panel Logística</span>
    </a>
</li>
{% endblock %}

{% block page_title %}Captura de Materiales{% endblock %}

{% block content %}
<form id="captureForm">
    <div class="capture-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: var(--accent-primary);">Lista de Materiales</h3>
            <button type="button" class="btn-secondary" onclick="addRow()">
                <i class="ph ph-plus"></i> Agregar Fila
            </button>
        </div>

        <div style="overflow-x: auto;">
            <table class="items-table" id="itemsTable">
                <thead>
                    <tr>
                        <th style="width: 180px;">Partida</th>
                        <th style="min-width: 180px;">Material</th>
                        <th style="width: 100px;">Forma</th>
                        <th style="width: 70px;">Cant.</th>
                        <th style="width: 80px;">U.M.</th>
                        <th style="width: 90px;">Diámetro</th>
                        <th style="width: 90px;">Largo</th>
                        <th style="width: 90px;">Ancho</th>
                        <th style="width: 90px;">Alto/Esp.</th>
                        <th style="width: 20px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div style="text-align: right; display: flex; justify-content: flex-end; align-items: center; gap: 1rem;">
        <div id="syncTime" style="color: var(--text-muted); font-size: 0.8rem;"></div>
        <div id="loadingStatus" style="color: var(--accent-primary); font-size: 0.9rem; display: none;">
            <i class="ph ph-spinner ph-spin"></i> Cargando partidas desde Notion...
        </div>
        <button type="button" class="btn-secondary" id="refreshBtn" onclick="fetchLogisticsData(true)"
            title="Forzar actualización desde Notion">
            <i class="ph ph-arrows-clockwise"></i> Recargar
        </button>
        <button type="submit" class="btn-primary" id="submitBtn">
            <i class="ph ph-paper-plane-right"></i> Enviar a Notion
        </button>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
    const STANDARD_INCHES = [
        "1/16", "1/8", "3/16", "1/4", "5/16", "3/8", "7/16", "1/2",
        "9/16", "5/8", "11/16", "3/4", "13/16", "7/8", "15/16", "1",
        "1 1/16", "1 1/8", "1 3/16", "1 1/4", "1 5/16", "1 3/8", "1 7/16", "1 1/2",
        "1 5/8", "1 3/4", "1 7/8", "2", "2 1/4", "2 1/2", "2 3/4", "3",
        "3 1/4", "3 1/2", "3 3/4", "4", "4 1/4", "4 1/2", "4 3/4", "5",
        "5 1/4", "5 1/2", "5 3/4", "6", "6 1/4", "6 1/2", "6 3/4", "7",
        "7 1/4", "7 1/2", "7 3/4", "8", "8 1/4", "8 1/2", "8 3/4", "9",
        "9 1/4", "9 1/2", "9 3/4", "10", "11", "12", "14", "16", "18", "20",
        "22", "24", "26", "28", "30", "32", "36", "40", "48", "60", "72",
        "78", "96", "120", "144", "168", "192", "240"
    ];

    let availablePartidas = [];
    let availableMateriales = [];

    async function fetchLogisticsData(force = false) {
        setLoading(true);
        try {
            if (force) {
                // Iniciar sincronización en segundo plano si se fuerza
                await fetch("{{ url_for('logistics.get_partidas') }}?force=true");
                await new Promise(r => setTimeout(r, 2000));
            }

            const response = await fetch("{{ url_for('logistics.get_all_data') }}");
            const result = await response.json();

            if (result.success) {
                availablePartidas.splice(0, availablePartidas.length, ...result.partidas.data);
                availableMateriales.splice(0, availableMateriales.length, ...result.materiales.data);
                updateDropdowns();

                if (result.is_syncing && (availablePartidas.length === 0 || availableMateriales.length === 0)) {
                    document.getElementById('syncTime').textContent = `Sincronizando por primera vez...`;
                    setTimeout(() => fetchLogisticsData(), 5000);
                } else if (result.partidas.timestamp) {
                    document.getElementById('syncTime').textContent = `Sincronizado: ${result.partidas.timestamp}`;
                }

                if (force) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Sincronización Iniciada',
                        text: 'Se ha iniciado la descarga de datos frescos en segundo plano. La lista se actualizará automáticamente en unos minutos.',
                        background: '#1a1a20',
                        color: '#fff',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Notion',
                    text: result.message,
                    background: '#1a1a20',
                    color: '#fff'
                });
            }
        } catch (error) {
            console.error("Error fetching logistics data:", error);
        } finally {
            setLoading(false);
        }
    }

    function setLoading(isLoading) {
        const submitBtn = document.getElementById('submitBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const status = document.getElementById('loadingStatus');
        const inputs = document.querySelectorAll('.table-input, .btn-secondary:not(#refreshBtn)');

        if (isLoading) {
            if (submitBtn) submitBtn.disabled = true;
            if (refreshBtn) refreshBtn.disabled = true;
            status.style.display = 'block';
            inputs.forEach(el => el.disabled = true);
        } else {
            if (submitBtn) submitBtn.disabled = false;
            if (refreshBtn) refreshBtn.disabled = false;
            status.style.display = 'none';
            inputs.forEach(el => el.disabled = false);
        }
    }

    function updateDropdowns() {
        if (availablePartidas.length > 0) {
            document.querySelectorAll('.partida-wrapper').forEach(el => el.classList.add('has-data'));
        }
        if (availableMateriales.length > 0) {
            document.querySelectorAll('.material-wrapper').forEach(el => el.classList.add('has-data'));
        }
    }

    function addRow() {
        const tbody = document.querySelector('#itemsTable tbody');
        const tr = document.createElement('tr');

        const partidaHasData = availablePartidas.length > 0 ? 'has-data' : '';
        const materialHasData = availableMateriales.length > 0 ? 'has-data' : '';

        tr.innerHTML = `
            <td>
                <div class="select-wrapper partida-wrapper ${partidaHasData}">
                    <input type="text" class="table-input partida-input" placeholder="Buscar partida..." autocomplete="off">
                </div>
            </td>
            <td>
                <div class="select-wrapper material-wrapper ${materialHasData}">
                    <input type="text" class="table-input material-input" placeholder="Buscar material.." required autocomplete="off">
                </div>
            </td>
            <td>
                <input type="text" class="table-input forma-input" readonly placeholder="-" style="background: rgba(255,255,255,0.05); text-align: center; font-size: 0.75rem;">
            </td>
            <td>
                <div class="quantity-wrapper">
                    <button type="button" class="quantity-btn minus-btn"><i class="ph ph-minus"></i></button>
                    <input type="number" class="table-input cantidad-input quantity-input" value="1" min="1">
                    <button type="button" class="quantity-btn plus-btn"><i class="ph ph-plus"></i></button>
                </div>
            </td>
            <td>
                <div class="select-wrapper um-wrapper has-data">
                    <input type="text" class="table-input um-input" value="mm" readonly autocomplete="off" style="cursor: pointer; text-align: center;">
                </div>
            </td>
            <td class="dim-cell"><div class="select-wrapper"><input type="text" class="table-input diametro-input" placeholder="0" autocomplete="off"></div></td>
            <td class="dim-cell"><div class="select-wrapper"><input type="text" class="table-input largo-input" placeholder="0" autocomplete="off"></div></td>
            <td class="dim-cell"><div class="select-wrapper"><input type="text" class="table-input ancho-input" placeholder="0" autocomplete="off"></div></td>
            <td class="dim-cell"><div class="select-wrapper"><input type="text" class="table-input alto-input" placeholder="0" autocomplete="off"></div></td>
            <td>
                <div style="color: #ef4444; cursor: pointer; text-align: center;" onclick="deleteRow(this)">
                    <i class="ph ph-trash"></i>
                </div>
            </td>
        `;

        const partidaInput = tr.querySelector('.partida-input');
        const materialInput = tr.querySelector('.material-input');
        const umSelect = tr.querySelector('.um-input');
        const dimInputs = {
            diametro: tr.querySelector('.diametro-input'),
            largo: tr.querySelector('.largo-input'),
            ancho: tr.querySelector('.ancho-input'),
            alto: tr.querySelector('.alto-input')
        };

        initCustomDropdown(partidaInput, () => availablePartidas, 'partida-wrapper');
        initCustomDropdown(materialInput, () => availableMateriales, 'material-wrapper');
        initCustomDropdown(umSelect, ['mm', 'in'], 'um-wrapper');

        Object.values(dimInputs).forEach(input => {
            initCustomDropdown(input, () => {
                return umSelect.value === 'in' ? STANDARD_INCHES : [];
            }, 'select-wrapper');
        });

        const qtyInput = tr.querySelector('.cantidad-input');
        tr.querySelector('.minus-btn').onclick = () => {
            const val = parseInt(qtyInput.value) || 1;
            if (val > 1) qtyInput.value = val - 1;
        };
        tr.querySelector('.plus-btn').onclick = () => {
            const val = parseInt(qtyInput.value) || 1;
            qtyInput.value = val + 1;
        };

        const validateDimensions = (e) => {
            const hasDiam = parseFraction(dimInputs.diametro.value) > 0;
            const hasAncho = parseFraction(dimInputs.ancho.value) > 0;
            const hasAlto = parseFraction(dimInputs.alto.value) > 0;
            const formaInput = tr.querySelector('.forma-input');

            if (hasDiam) {
                dimInputs.ancho.disabled = true;
                dimInputs.alto.disabled = true;
                dimInputs.ancho.style.opacity = '0.3';
                dimInputs.alto.style.opacity = '0.3';
                formaInput.value = 'Cilíndrica';
            } else if (hasAncho || hasAlto) {
                dimInputs.diametro.disabled = true;
                dimInputs.diametro.style.opacity = '0.3';
                formaInput.value = 'Prismática';
            } else {
                dimInputs.diametro.disabled = false;
                dimInputs.ancho.disabled = false;
                dimInputs.alto.disabled = false;
                dimInputs.diametro.style.opacity = '1';
                dimInputs.ancho.style.opacity = '1';
                dimInputs.alto.style.opacity = '1';
                formaInput.value = '-';
            }
        };

        Object.values(dimInputs).forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const originalValue = e.target.value;
                const cleanedValue = originalValue.replace(/[^0-9\/ ]/g, '');
                if (originalValue !== cleanedValue) {
                    e.target.value = cleanedValue;
                }
            });
            input.addEventListener('input', validateDimensions);
        });

        tbody.appendChild(tr);
    }

    function parseFraction(val) {
        if (!val) return 0;
        if (typeof val === 'number') return val;
        val = val.toString().trim();
        if (!val.includes('/') && !val.includes(' ')) return parseFloat(val) || 0;
        let parts = val.split(' ');
        let decimal = 0;
        if (parts.length === 2) {
            decimal = parseFloat(parts[0]);
            val = parts[1];
        } else if (parts.length === 1 && val.includes('/')) {
        } else {
            return parseFloat(val) || 0;
        }
        let fracParts = val.split('/');
        if (fracParts.length === 2) {
            decimal += parseFloat(fracParts[0]) / parseFloat(fracParts[1]);
        }
        return decimal;
    }

    function deleteRow(btn) {
        const tbody = document.querySelector('#itemsTable tbody');
        if (tbody.children.length > 1) {
            btn.closest('tr').remove();
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'Atención',
                text: 'Debe haber al menos una partida.',
                background: '#1a1a20',
                color: '#fff'
            });
        }
    }

    fetchLogisticsData();
    addRow();

    document.getElementById('captureForm').onsubmit = async (e) => {
        e.preventDefault();
        const rows = document.querySelectorAll('#itemsTable tbody tr');
        const items = [];

        for (const row of rows) {
            const partidaInput = row.querySelector('.partida-input');
            const materialInput = row.querySelector('.material-input');
            const formaInput = row.querySelector('.forma-input');

            const partida = partidaInput.value.trim();
            const material = materialInput.value.trim();
            const forma = formaInput.value;

            if (!partida || !material || forma === '-') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Campos incompletos',
                    text: 'Asegúrese de seleccionar partida, material y medidas válidas.',
                    background: '#1a1a20',
                    color: '#fff'
                });
                return;
            }

            const diamRaw = row.querySelector('.diametro-input').value;
            const largoRaw = row.querySelector('.largo-input').value;
            const anchoRaw = row.querySelector('.ancho-input').value;
            const altoRaw = row.querySelector('.alto-input').value;
            const um = row.querySelector('.um-input').value;
            const cantidad = parseInt(row.querySelector('.cantidad-input').value) || 1;

            items.push({
                partida, material, forma, cantidad, um,
                diametro: diamRaw, largo: largoRaw, ancho: anchoRaw, alto: altoRaw
            });
        }

        const submitBtn = document.getElementById('submitBtn');
        const originalContent = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> Enviando...';

        try {
            const response = await fetch("{{ url_for('logistics.submit_capture') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: items })
            });
            const result = await response.json();
            if (result.success) {
                await Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: result.message,
                    background: '#1a1a20',
                    color: '#fff'
                });
                document.querySelector('#itemsTable tbody').innerHTML = '';
                addRow();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message,
                background: '#1a1a20',
                color: '#fff'
            });
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalContent;
        }
    };
</script>
{% endblock %}