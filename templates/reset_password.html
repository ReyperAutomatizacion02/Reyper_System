<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Establecer Nueva Contraseña | AutoIntelli</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo.svg') }}" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <main>
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Reyper System"
                        style="height: 60px; margin-bottom: 1.5rem;">
                    <h2>Nueva Contraseña</h2>
                    <p style="color: var(--text-secondary);">Ingresa tu nueva contraseña de acceso</p>
                </div>

                <form method="POST" action="{{ url_for('auth.reset_password') }}" id="resetForm">
                    <input type="hidden" name="code" value="{{ code or '' }}">
                    <input type="hidden" name="access_token" value="">
                    <input type="hidden" name="refresh_token" value="">
                    <div class="form-group">
                        <label for="password">Nueva Contraseña</label>
                        <input type="password" id="password" name="password" class="form-input"
                            placeholder="Min. 10 caracteres" required>
                        <!-- Password Requirements -->
                        <div id="password-requirements"
                            style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--text-secondary); background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                            <ul style="list-style: none; padding-left: 5px;">
                                <li id="req-length" style="margin-bottom: 2px;"><i class="ph ph-circle"></i> Mínimo 10
                                    caracteres</li>
                                <li id="req-upper" style="margin-bottom: 2px;"><i class="ph ph-circle"></i> 1 Letra
                                    mayúscula</li>
                                <li id="req-lower" style="margin-bottom: 2px;"><i class="ph ph-circle"></i> 1 Letra
                                    minúscula</li>
                                <li id="req-number" style="margin-bottom: 2px;"><i class="ph ph-circle"></i> 1 Número
                                </li>
                                <li id="req-special" style="margin-bottom: 2px;"><i class="ph ph-circle"></i> 1 Carácter
                                    especial</li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">Confirmar Contraseña</label>
                        <input type="password" id="confirm_password" name="confirm_password" class="form-input"
                            placeholder="Repite la contraseña" required>
                        <div id="match-message" style="font-size: 0.8rem; margin-top: 4px; display: none;"></div>
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;" id="submitBtn" disabled>Restablecer
                        Contraseña</button>
                </form>
            </div>
        </div>
    </main>

    <div id="flash-messages" data-messages='{{ get_flashed_messages(with_categories=true) | tojson | safe }}'></div>

    <script>
        // Capture code from URL (Query or Hash)
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            // Try query string
            let regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            let results = regex.exec(url);
            if (results && results[2]) return decodeURIComponent(results[2].replace(/\+/g, ' '));

            // Try hash fragment
            regex = new RegExp('[#&]' + name + '(=([^&#]*)|&|#|$)');
            results = regex.exec(url);
            if (results && results[2]) return decodeURIComponent(results[2].replace(/\+/g, ' '));

            return null;
        }

        const urlCode = getParameterByName('code');
        const accessToken = getParameterByName('access_token');
        const refreshToken = getParameterByName('refresh_token');
        const tokenHash = getParameterByName('token_hash');
        const type = getParameterByName('type');
        const codeInput = document.querySelector('input[name="code"]');
        const accessTokenInput = document.querySelector('input[name="access_token"]');
        const refreshTokenInput = document.querySelector('input[name="refresh_token"]');

        if (tokenHash) codeInput.value = tokenHash;
        else if (urlCode) codeInput.value = urlCode;

        if (accessToken) {
            accessTokenInput.value = accessToken;
            // Also put it in code as fallback
            if (!codeInput.value) codeInput.value = accessToken;
        }
        if (refreshToken) refreshTokenInput.value = refreshToken;

        // Ensure type is recovery if coming from email
        if (type === 'recovery') {
            // Optional: store type if needed, but we'll assume recovery in backend for this route
        }

        // Shared logic with register.html
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirm_password');
        const submitBtn = document.getElementById('submitBtn');
        const matchMessage = document.getElementById('match-message');
        const form = document.getElementById('resetForm');

        const reqs = {
            length: { regex: /.{10,}/, element: document.getElementById('req-length') },
            upper: { regex: /[A-Z]/, element: document.getElementById('req-upper') },
            lower: { regex: /[a-z]/, element: document.getElementById('req-lower') },
            number: { regex: /[0-9]/, element: document.getElementById('req-number') },
            special: { regex: /[!@#$%^&*(),.?":{}|<>]/, element: document.getElementById('req-special') }
        };

        function updateState() {
            const val = passwordInput.value;
            let allValid = true;

            for (const key in reqs) {
                const req = reqs[key];
                const icon = req.element.querySelector('i');
                if (req.regex.test(val)) {
                    req.element.style.color = '#10b981';
                    icon.classList.replace('ph-circle', 'ph-check-circle');
                } else {
                    req.element.style.color = 'var(--text-secondary)';
                    icon.classList.replace('ph-check-circle', 'ph-circle');
                    allValid = false;
                }
            }

            const isMatch = (confirmInput.value !== '' && passwordInput.value === confirmInput.value);
            if (confirmInput.value !== '') {
                matchMessage.style.display = 'block';
                matchMessage.textContent = isMatch ? 'Las contraseñas coinciden' : 'Las contraseñas no coinciden';
                matchMessage.style.color = isMatch ? '#10b981' : '#ef4444';
            } else {
                matchMessage.style.display = 'none';
            }

            submitBtn.disabled = !(allValid && isMatch);
            submitBtn.style.opacity = (allValid && isMatch) ? '1' : '0.6';
        }

        passwordInput.addEventListener('input', updateState);
        confirmInput.addEventListener('input', updateState);

        form.addEventListener('submit', function () {
            submitBtn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> Procesando...';
            submitBtn.disabled = true;
        });

        // Flash Handling
        const flashData = document.getElementById('flash-messages').dataset.messages;
        const flashMessages = flashData ? JSON.parse(flashData) : [];
        if (flashMessages && flashMessages.length > 0) {
            flashMessages.forEach(msg => {
                Swal.fire({
                    icon: msg[0] === 'error' ? 'error' : 'success',
                    text: msg[1],
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 4000,
                    background: '#1a1a20',
                    color: '#fff'
                });
            });
        }
    </script>
</body>

</html>