<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control | AutoIntelli</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo.svg') }}" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>

<body style="background-image: none; background-color: var(--bg-color);">
    <div class="dashboard-layout">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="{{ url_for('main.dashboard') }}" class="logo" style="justify-content: center;">
                    <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Reyper System"
                        style="height: 45px; width: auto;">
                </a>
                <i class="ph ph-x sidebar-close" id="sidebar-close" style="display:none;"></i>
            </div>

            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="{{ url_for('main.dashboard') }}" class="menu-link active">
                        <i class="ph ph-squares-four"></i> Inicio
                    </a>
                </li>

                {% if 'Admin' in roles %}
                <li class="menu-item">
                    <a href="{{ url_for('admin.users') }}" class="menu-link" style="color: #ef4444;">
                        <i class="ph ph-users-three"></i> Usuarios
                    </a>
                </li>
                {% endif %}

                <li
                    style="margin: 1.5rem 0 0.5rem 1rem; font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.05em;">
                    Módulos</li>

                {% if modules %}
                {% for mod in modules %}
                <li class="menu-item">
                    <!-- CORRECCIÓN AQUÍ: sales_dashboard -->
                    <a href="{{ url_for('sales.home') if mod.name == 'Ventas' else '#' }}" class="menu-link">
                        <i class="ph {{ mod.icon }}"></i> {{ mod.label }}
                    </a>
                </li>
                {% endfor %}
                {% else %}
                <li style="padding: 1rem; color: var(--text-secondary); font-size: 0.9rem; font-style: italic;">
                    No tienes módulos asignados. Contacta al administrador.
                </li>
                {% endif %}
            </ul>

            <div style="margin-top: auto;">
                <a href="{{ url_for('auth.logout') }}" class="menu-link" style="color: #ef4444;">
                    <i class="ph ph-sign-out"></i> Cerrar Sesión
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar" style="justify-content: space-between;">
                <button class="mobile-menu-toggle" id="dashboard-toggle">
                    <i class="ph ph-list"></i>
                </button>
                <div class="user-info"
                    style="display: flex; align-items: center; gap: 1rem; color: var(--text-primary); margin-left: auto;">
                    <div style="text-align: right;">
                        <div style="font-weight: 600;">{{ user.username or user.email }}</div>
                        {% if user.username %}
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 2px;">{{ user.email
                            }}</div>
                        {% endif %}
                        <div style="font-size: 0.8rem; margin-top: 2px;">
                            {% if roles %}
                            {% for role in roles %}
                            <span
                                style="background: var(--accent-primary); padding: 2px 6px; border-radius: 4px; margin-left: 4px; font-size: 0.7rem;">{{
                                role }}</span>
                            {% endfor %}
                            {% else %}
                            <span style="opacity: 0.7;">Sin rol</span>
                            {% endif %}
                        </div>
                    </div>
                    <div
                        style="width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="ph ph-user"></i>
                    </div>
                </div>
            </div>

            <div class="container" style="padding: 0;">
                <h1 style="margin-bottom: 2rem;">Inicio</h1>

                <div class="features-grid">
                    {% if modules %}
                    {% for mod in modules %}
                    {% set target_url = '#' %}
                    {% if mod.name == 'Ventas' %}
                    <!-- CORRECCIÓN AQUÍ: sales_dashboard -->
                    {% set target_url = url_for('sales.home') %}
                    {% endif %}

                    <a href="{{ target_url }}" style="text-decoration: none; color: inherit; display: block;">
                        <div class="feature-card" style="cursor: pointer; height: 100%;">
                            <div class="feature-icon">
                                <i class="ph {{ mod.icon }}"></i>
                            </div>
                            <h3>{{ mod.label }}</h3>
                            <p>Acceder al panel de {{ mod.label }}</p>
                        </div>
                    </a>
                    {% endfor %}
                    {% else %}
                    <div class="feature-card" style="grid-column: 1 / -1; text-align: center; padding: 4rem;">
                        <div class="feature-icon">
                            <i class="ph ph-lock-key" style="font-size: 3rem;"></i>
                        </div>
                        <h3>Acceso Restringido</h3>
                        <p>Tu cuenta está aprobada pero no tienes roles asignados. Solicita acceso a un módulo.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <!-- Flash Messages Data -->
    <div id="flash-messages" data-messages='{{ get_flashed_messages(with_categories=true) | tojson | safe }}'></div>

    <!-- Dashboard Sidebar Script -->
    <script>
        // Handle Flash Messages
        const flashData = document.getElementById('flash-messages').dataset.messages;
        const flashMessages = flashData ? JSON.parse(flashData) : [];
        if (flashMessages && flashMessages.length > 0) {
            flashMessages.forEach(msg => {
                const category = msg[0];
                const message = msg[1];
                // Check if Swal is defined (it might not be if CDN fail, but we added it)
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: category === 'error' ? 'error' : 'success',
                        title: category === 'error' ? 'Error' : 'Éxito',
                        text: message,
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 4000,
                        timerProgressBar: true,
                        background: '#1a1a20',
                        color: '#fff'
                    });
                }
            });
        }

        const sidebar = document.getElementById('sidebar');
        const dashToggle = document.getElementById('dashboard-toggle');
        const closeBtn = document.getElementById('sidebar-close');
        const overlay = document.getElementById('sidebar-overlay');

        function toggleSidebar() {
            if (sidebar) {
                sidebar.classList.toggle('active');
                if (overlay) overlay.classList.toggle('active');
            }
        }

        if (dashToggle) dashToggle.addEventListener('click', toggleSidebar);
        if (closeBtn) closeBtn.addEventListener('click', toggleSidebar);
        if (overlay) overlay.addEventListener('click', toggleSidebar);
    </script>
</body>

</html>